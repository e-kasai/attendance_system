---
# アプリケーション名

coachtech勤怠管理アプリ
---

# 概要

以下の機能を実装した勤怠管理アプリです

一般ユーザー（スタッフ）

- ユーザー登録
- メール認証
- 勤怠の登録（出勤・退勤・休憩）
- 勤怠一覧・詳細の確認
- 申請一覧・詳細確認（承認待ち・承認済み）
- 承認済み勤怠記録の修正

管理者ユーザー

- 勤怠記録確認（日次・スタッフごとの月次勤怠記録・各勤怠の詳細）
- スタッフ一覧の確認
- 申請一覧・詳細確認（承認待ち・承認済み）

---

# 環境構築手順

```bash
# git clone (プロジェクトをcloneしたいディレクトリから実行)
git clone git@github.com:e-kasai/attendance_system.git         # SSHの場合はこちら
git clone https://github.com/e-kasai/attendance_system.git     # HTTPSの場合はこちら

# 環境構築
# プロジェクトルートに移動して make init 実行
cd attendance_system
make init

```

### コード整形（任意）

- 本プロジェクトは Prettier を利用しています。
- 必須ではありませんが、次のコマンドで同じ整形ルールを適用できます。

```bash
npm install
npx prettier --write .
```

**環境構築は以上です。**

---

# 補足：環境について

### 1. 環境をクリーンに戻す必要が出たとき

- **DB をまっさらな状態** へ戻したい場合は下記コマンドを実行してください。
    `db:seed` のみ再実行すると `insert` 方式のため重複レコードが発生します。

```bash

# phpコンテナ内から実行

docker compose exec php bash
php artisan migrate:fresh --seed

```

### 2. arm環境用の設定について

M1/M2 Mac など arm環境での互換性を考慮し、 主に MySQL 用に `platform: linux/x86_64` を指定しています。
必須ではありませんが、念のためMySQL以外のサービスにも指定しています。

### 3. コード整形

本リポジトリの Blade テンプレートおよびソースコードは
Prettier（prettier-plugin-blade）で整形済みです。

---

# 使用技術

- Laravel 8.83.8
- PHP 8.1.33
- MySQL 8.0.26
- Docker/docker-compose
- MailHog v1.0.1
- node.js v18.19.1
- npm v10.9.2

---

# ER 図

![ER図](./docs/er.png)

---

# URL

- 開発環境：http://localhost/
- phpMyAdmin：http://localhost:8080/

---

# 開発用ログイン情報

Seeder により以下のユーザーが自動作成されます。

- 管理者ユーザー
    - メール: admin@gmail.com

- 一般ユーザー
    - メール: staffx@gmail.com (xには1～4のいずれかの数字を入れてください)

パスワードは全て"password"です。
Seederを経由して作成されるユーザーは登録画面を通らないため、認証メールが送付されません。
認証メールの送信や再送の手間を省くため、ダミーユーザーはあらかじめ認証済みとして登録しています。

---

# テスト実行

- テスト一括実行時は以下のコマンドをご使用ください。

```bash
  docker compose exec php bash
  php artisan test
```

---

# 補足：仕様について

---

## 1. 基本設計書について

Googleスプレッドシート上には、「基本設計書（生徒様入力用）」および「テーブル仕様書（生徒様入力用）」のタブが用意されています。
これらは編集制限があるため列幅を変更できず、そのまま使用すると内容が途中で見切れてしまいます。
そのため、列幅を調整したコピータブを作成して使用しています。

設計内容（基本設計・DB設計）を確認する際は、**「（生徒様入力用）」と記載されていないタブ**をご参照ください。

## ２. レスポンシブ対応の基準設定

将来的な保守性を考慮し、最新スマホ幅(iphone16等)を基準に最小サイズを設定しています

---

## 3. ログイン画面について

管理者のログイン画面を下記方法でスタッフとは分けて表示しています
理由：仕様のパスが`/admin/login`と明記されており、`admin/`でまとめることで保守性が高い為

1. /loginを通すためルート設定でリダイレクトをかける
   `web.php`

- 一般ユーザー /login
- 管理者 /admin/login (/admin/login → /login にリダイレクトさせる)

```php
// routes/web.php
Route::get('/admin/login', function () {
    return redirect('/login?role=admin');
});
```

2. ログイン後のリダイレクトを条件分岐する（ログイン画面をスタッフとユーザーで条件分岐）
   `FortifyServiceProvider.php`

```php
Fortify::loginView(function () {
    if (request('role') === 'admin') {
        return view('admin.login');
    }
    return view('staff.auth.login');
});
```

---

## 4. 承認済みタブのUIについて（FN032・FN048関連）

機能要件に明記された　"カラムの項目がUIと一致していること"についてですが
Figma上では「承認済み」タブのUIが提示されておらず
機能要件上も「承認日時」等の新たなカラム項目は定義されていないことから、
「承認待ち」タブと同一構成で実装しました。

※ 仕様上UI提示がないため、同一UI構成での実装を正と判断しています。

---

## 5. 新規登録とメール認証の設計について

要件には「新規会員登録後にメール認証をしないでログインを試みた場合は、メール認証誘導画面へ遷移する」とあります。
本実装では Fortify の標準仕様に従い、登録完了時に自動的にログインされます。

そのため「登録直後は未ログイン」という状態はありませんが、
メール未認証ユーザーが"メール認証が必要なページ"にアクセスすると
`verified` ミドルウェアにより `/email/verify`（認証誘導画面）へリダイレクトされます。

これにより要件にある「未認証時はメール認証誘導画面に遷移する」を満たしています。

---

## 6. MailHogのHTML表示について（既知の不具合）

MailHogの「HTML」タブでは、まれにメール本文が初回表示時に真っ白になることがあります。
これはLaravelやテンプレートの不具合ではなく、MailHog側（iframeを使用した描画）の問題です。
「Plain text」タブや「Source」タブでは正常に内容を確認できます。

ページを複数回リロードするか、Edgeブラウザで開くと正しく表示されます。

** 補足 **
これはMailHogのHTMLレンダリング仕様に起因するため、Laravel側の修正は不要です。
開発中のみ発生する既知の問題としてご理解ください。

---

## 7. 退勤後の再アクセス時挙動

出勤は1日1回のみを想定しています。
退勤ボタン押下後、同日中に再度勤怠登録画面へアクセスした場合「退勤済み」の画面を表示する仕様としています。

## 8. 勤怠ロジック概要

勤怠登録、勤怠時間計算においては、可読性と保守性の観点から
責務をコントローラー、サービスクラス、モデルイベントで分担しています。

### 責務分担

各層が役割を明確に分けることで、処理の見通しを良くし、変更に強い構成としています。

コントローラー:`StaffAttendanceController.php`

- リクエストを受け取ってどの処理をするか（出勤／退勤／休憩開始など）判断
- サービスクラスに処理を委譲

サービスクラス:`AttendanceService.php`

- ビジネスロジックを担当（出勤・退勤・休憩など）
- `Attendance`モデルの`create()`や`update()`を呼びモデルライフサイクルイベントを発火

モデルイベント:`Attendance.php`

- `saving`（保存前）イベントで、勤怠の自動計算を担当

### 処理の流れ

1. `Controller` から `Serviceクラス` に処理を委譲
2. `Serviceクラス内`で `Attendance::create()` または `update()`
3. `Attendance` モデルの `saving` イベントで勤務時間・休憩時間を自動計算
4. DB保存時に `work_time`（総勤務時間）と `break_time`（総休憩時間）を記録し、合計勤務時間を算出する

勤怠時間は分単位（秒切り捨て）で計算し、マイナス値にならない様制御しています。

---

### 9. 申請一覧画面のルート設計

設計書に記載の「管理者と一般ユーザーで同一パスを使用し、認証ミドルウェアで区別」という仕様については、
認証情報をもとに表示内容を切り替える意図だと判断し、本実装ではアプリケーション層での制御としています。

Laravelでは同一URL・同一メソッドを複数定義した場合
先に定義されたルートが優先されるため、ルート層での区別は不可能です。
また、ミドルウェアは本来「アクセスを通す／弾く」責務を担うものであり、
処理の振り分けに用いるのは、その役割の範囲外となるためこのような実装としました。

### 10. validation errorメッセージについて

Googleスプレッドシート上では、休憩時間の修正に関するバリデーションエラーメッセージが、以下のように設定されています。

1. 休憩開始時間が出勤時間より前、または退勤時間より後の場合
   → 「休憩時間が不適切な値です」

2. 休憩終了時間が退勤時間より後の場合
   → 「休憩時間もしくは退勤時間が不適切な値です」

一方、LMSの要件定義では、次のように定義されています。

1. 休憩開始時間または終了時間が勤務時間外に設定されている場合
   → 「休憩時間が勤務時間外です。」

スプレッドシート側のメッセージは条件が重複していたため、LMSの要件を採用し、
**休憩修正時のバリデーションエラーメッセージは「休憩時間が勤務時間外です。」に統一しています。**
詳細は、スプレッドシートの「Validation」タブをご確認ください。
